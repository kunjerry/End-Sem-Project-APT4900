document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('verification-form') || document.getElementById('verifyForm');
  const evidenceIdInput = document.getElementById('evidenceIdInput') || document.getElementById('evidenceId');
  const originalHashDisplay = document.getElementById('original-hash-display');
  const calculatedHashDisplay = document.getElementById('calculated-hash-display');
  const resultDiv = document.getElementById('verification-result');
  const resultText = document.getElementById('result-text');
  const resultMessage = document.getElementById('result-message');
  const exportBtn = document.getElementById('exportCertificateBtn');

  const optionalFileInput = document.getElementById('fileToVerify') || null;

  if (!form) {
    console.warn('Verification form not found.');
    return;
  }

  // If URL has id, prefill
  const urlId = new URLSearchParams(window.location.search).get('id');
  if (urlId && evidenceIdInput) evidenceIdInput.value = urlId;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const evidenceId = (evidenceIdInput && evidenceIdInput.value) ? evidenceIdInput.value.trim() : '';
    if (!evidenceId) {
      alert('Enter an Evidence ID or scan a QR code.');
      return;
    }

    const verifyBtn = document.getElementById('verifyBtn') || form.querySelector('button[type="submit"]');
    if (verifyBtn) {
      verifyBtn.disabled = true;
      verifyBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Verifying...';
    }
    if (resultDiv) resultDiv.classList.add('d-none');

    try {
      const fd = new FormData();
      fd.append('evidenceId', evidenceId);
      if (optionalFileInput && optionalFileInput.files && optionalFileInput.files[0]) {
        fd.append('file', optionalFileInput.files[0]);
      }

      const res = await fetch('/api/evidence/verify-hash', {
        method: 'POST',
        body: fd
      });

      if (!res.ok) {
        const txt = await res.text();
        console.error('Verify API error', res.status, txt);
        alert('Verification failed. Check console.');
        return;
      }

      const data = await res.json();
      if (originalHashDisplay) originalHashDisplay.textContent = data.originalHash || '—';
      if (calculatedHashDisplay) calculatedHashDisplay.textContent = data.calculatedHash || '—';

      const match = data.match === true;

      if (resultDiv && resultText && resultMessage) {
        resultDiv.classList.remove('d-none');
        if (match) {
          resultDiv.classList.remove('bg-danger'); resultDiv.classList.add('bg-success', 'text-white');
          resultText.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i> INTEGRITY VERIFIED';
          resultMessage.textContent = 'The evidence hash matches the original stored record.';
          if (exportBtn) exportBtn.disabled = false;
        } else {
          resultDiv.classList.remove('bg-success'); resultDiv.classList.add('bg-danger', 'text-white');
          resultText.innerHTML = '<i class="bi bi-x-octagon-fill me-2"></i> INTEGRITY ALERT';
          resultMessage.textContent = 'Calculated hash does NOT match the original record.';
          if (exportBtn) exportBtn.disabled = true;
        }
      }
    } catch (err) {
      console.error('Verification error', err);
      alert('Verification failed (network or server).');
    } finally {
      if (verifyBtn) {
        verifyBtn.disabled = false;
        verifyBtn.innerHTML = '<i class="bi bi-fingerprint me-2"></i> Recalculate & Verify Hash';
      }
    }
  });

  // create a simple printable certificate
  if (exportBtn) {
    exportBtn.addEventListener('click', () => {
      const evidenceId = (evidenceIdInput && evidenceIdInput.value) ? evidenceIdInput.value.trim() : '';
      const orig = originalHashDisplay?.textContent || '';
      const calc = calculatedHashDisplay?.textContent || '';
      const html = `
        <html><head><title>Verification Certificate</title></head>
        <body style="font-family:Arial,Helvetica,sans-serif">
          <h2>Evidence Verification Certificate</h2>
          <p><strong>Evidence ID:</strong> ${evidenceId}</p>
          <p><strong>Original Hash:</strong> <code>${orig}</code></p>
          <p><strong>Calculated Hash:</strong> <code>${calc}</code></p>
          <p>Verified on: ${new Date().toLocaleString()}</p>
          <hr>
          <p>Certificate generated by Evidence CoC System</p>
        </body></html>
      `;
      const w = window.open('', '_blank');
      w.document.write(html);
      w.document.close();
      w.print();
    });
  }
});
