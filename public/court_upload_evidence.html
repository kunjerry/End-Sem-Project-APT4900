<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Court - Upload Evidence</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f4f6f9}
    .topbar{background:#212529;color:#fff;padding:12px 18px;display:flex;justify-content:space-between;align-items:center}
    .card { box-shadow: 0 4px 14px rgba(0,0,0,.06) }
  </style>
</head>
<body>
  <div class="topbar">
    <div><strong>Upload Evidence</strong><span class="ms-3 text-muted" id="userLabel">Loading...</span></div>
    <div>
      <a class="btn btn-sm btn-light me-2" href="court_dashboard.html">Dashboard</a>
      <button id="logoutBtn" class="btn btn-sm btn-danger">Logout</button>
    </div>
  </div>

  <main class="container py-4">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="card p-4">
          <h4>Upload New Evidence</h4>
          <form id="uploadForm">
            <div class="mb-3">
              <label class="form-label">Case Number</label>
              <input id="caseNumber" name="caseNumber" class="form-control" placeholder="CR/101/2025" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Evidence Type</label>
              <select id="evidenceType" name="evidenceType" class="form-select" required>
                <option value="">Select type</option>
                <option>Photo/Video</option>
                <option>Forensic Disk Image</option>
                <option>Document/Log</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea id="description" name="description" class="form-control" rows="3"></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">File</label>
              <input id="evidenceFile" name="file" type="file" class="form-control" required>
              <div class="form-text">Large files supported. For forensic images consider using server-side gridfs in future.</div>
            </div>

            <div class="mb-3">
              <label class="form-label">Signature (optional - PNG base64)</label>
              <input id="signatureFile" type="file" accept="image/*" class="form-control">
              <div class="form-text">If you have officer signature image, upload here.</div>
            </div>

            <button class="btn btn-primary" id="uploadBtn" type="submit">Upload Evidence</button>
            <div id="progress" class="mt-3" style="display:none;">
              <div class="progress"><div id="progressBar" class="progress-bar" role="progressbar" style="width:0%">0%</div></div>
            </div>
            <div id="resultMsg" class="mt-3"></div>
          </form>
        </div>
      </div>
    </div>
  </main>

<script>
(function(){
  // Auth + logout
  const isLoggedIn = localStorage.getItem('isLoggedIn');
  const role = localStorage.getItem('userRole');
  const uname = localStorage.getItem('username') || '';
  document.getElementById('userLabel').textContent = uname ? `Signed in as ${uname}` : '';

  if (!isLoggedIn || isLoggedIn !== 'true') { alert('Please login'); window.location.href='index.html'; return; }
  if (role !== 'court' && role !== 'admin' && role !== 'officer' && role !== 'analyst') {
    alert('Unauthorized'); window.location.href = 'index.html'; return;
  }

  document.getElementById('logoutBtn').addEventListener('click', ()=> {
    localStorage.clear(); window.location.href='index.html';
  });

  const form = document.getElementById('uploadForm');
  const uploadBtn = document.getElementById('uploadBtn');
  const progress = document.getElementById('progress');
  const progressBar = document.getElementById('progressBar');
  const resultMsg = document.getElementById('resultMsg');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    uploadBtn.disabled = true;
    resultMsg.innerHTML = '';
    progress.style.display = 'block';
    progressBar.style.width = '0%'; progressBar.textContent = '0%';

    const fileInput = document.getElementById('evidenceFile');
    if (!fileInput.files.length) {
      alert('Select a file'); uploadBtn.disabled=false; return;
    }

    
    const fd = new FormData();
    fd.append('file', fileInput.files[0]);
    fd.append('caseNumber', document.getElementById('caseNumber').value);
    fd.append('evidenceType', document.getElementById('evidenceType').value);
    fd.append('description', document.getElementById('description').value);
    fd.append('officerId', localStorage.getItem('userId') || '');

    // optional signature 
    const sigInput = document.getElementById('signatureFile');
    if (sigInput.files.length) {
      const sigFile = sigInput.files[0];
      const b64 = await fileToBase64(sigFile);
      fd.append('signatureBase64', b64);
    }

    // Used XMLHttpRequest to show progress 
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/api/evidence/upload', true);

    xhr.upload.onprogress = function(evt) {
      if (evt.lengthComputable) {
        const pct = Math.round((evt.loaded / evt.total) * 100);
        progressBar.style.width = pct + '%';
        progressBar.textContent = pct + '%';
      }
    };

    xhr.onload = function() {
      uploadBtn.disabled = false;
      if (xhr.status >= 200 && xhr.status < 300) {
        try {
          const resp = JSON.parse(xhr.responseText);
          if (resp.success) {
            resultMsg.innerHTML = `<div class="alert alert-success">Uploaded. Evidence ID: <strong>${resp.evidenceId}</strong></div>`;
            form.reset();
            progress.style.display = 'none';
          } else {
            resultMsg.innerHTML = `<div class="alert alert-danger">Error: ${resp.message || 'Upload failed'}</div>`;
          }
        } catch (e) {
          resultMsg.innerHTML = `<div class="alert alert-danger">Server returned unexpected response.</div>`;
        }
      } else {
        resultMsg.innerHTML = `<div class="alert alert-danger">Upload failed (status ${xhr.status})</div>`;
      }
    };

    xhr.onerror = function() {
      uploadBtn.disabled = false;
      resultMsg.innerHTML = `<div class="alert alert-danger">Network error during upload.</div>`;
    };

    xhr.send(fd);
  });

  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }
})();
</script>
</body>
</html>
