<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Court - Submit Report</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f4f6f9}
    .topbar{background:#222;color:#fff;padding:12px 18px;display:flex;justify-content:space-between;align-items:center}
    .card{box-shadow:0 6px 18px rgba(0,0,0,.06)}
  </style>
</head>
<body>
  <div class="topbar">
    <div><strong>Submit Court Report</strong><span id="userLabel" class="ms-3 text-muted"></span></div>
    <div>
      <a class="btn btn-sm btn-light me-2" href="court_dashboard.html">Dashboard</a>
      <button id="logoutBtn" class="btn btn-sm btn-danger">Logout</button>
    </div>
  </div>

  <main class="container py-4">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="card p-4">
          <h4>Create & Submit Report</h4>

          <form id="reportForm">
            <div class="mb-3">
              <label class="form-label">Case Number</label>
              <input id="caseNumber" name="caseNumber" class="form-control" placeholder="CR/101/2025" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Report Title</label>
              <input id="title" name="title" class="form-control" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Report Body</label>
              <textarea id="body" name="body" class="form-control" rows="8" required></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">Attach Evidence (optional)</label>
              <input id="evidenceAttach" type="file" class="form-control" />
            </div>

            <button class="btn btn-primary" type="submit">Submit Report</button>
            <div id="reportMsg" class="mt-3"></div>
          </form>
        </div>
      </div>
    </div>
  </main>

<script>
(function(){
  // auth
  const isLoggedIn = localStorage.getItem('isLoggedIn');
  const role = localStorage.getItem('userRole');
  const uname = localStorage.getItem('username') || '';
  document.getElementById('userLabel').textContent = uname ? `Signed in as ${uname}` : '';

  if (!isLoggedIn || isLoggedIn !== 'true') { alert('Please login'); window.location.href='index.html'; return; }
  if (role !== 'court' && role !== 'admin' && role !== 'analyst') { alert('Not allowed'); window.location.href='index.html'; return; }

  document.getElementById('logoutBtn').addEventListener('click', ()=>{ localStorage.clear(); window.location.href='index.html'; });

  const form = document.getElementById('reportForm');
  const msg = document.getElementById('reportMsg');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    msg.innerHTML = '';

    // Prepare payload
    const caseNumber = document.getElementById('caseNumber').value.trim();
    const title = document.getElementById('title').value.trim();
    const body = document.getElementById('body').value.trim();
    const attach = document.getElementById('evidenceAttach').files[0];

    if (!caseNumber || !title || !body) {
      msg.innerHTML = '<div class="alert alert-warning">Please fill required fields.</div>';
      return;
    }

    
    try {
      const fd = new FormData();
      fd.append('caseNumber', caseNumber);
      fd.append('title', title);
      fd.append('body', body);
      fd.append('author', localStorage.getItem('username') || 'unknown');
      if (attach) fd.append('attachment', attach);

      // attempt POST
      const res = await fetch('/api/court/reports', { method: 'POST', body: fd });

      if (res.ok) {
        const json = await res.json();
        msg.innerHTML = `<div class="alert alert-success">Report submitted. ${json.message ? json.message : ''}</div>`;
        form.reset();
        return;
      } else {
        // if 404 or error, fallback to local save
        console.warn('Server rejected report, fallback saving locally', res.status);
        throw new Error('Server rejected request');
      }
    } catch (err) {
      // fallback: save into localStorage pendingCourtReports for later sync
      const pending = JSON.parse(localStorage.getItem('pendingCourtReports') || '[]');
      pending.push({
        id: 'local-' + Date.now(),
        caseNumber, title, body,
        author: localStorage.getItem('username') || 'unknown',
        timestamp: new Date().toISOString()
      });
      localStorage.setItem('pendingCourtReports', JSON.stringify(pending));
      msg.innerHTML = '<div class="alert alert-info">Report saved locally (no server endpoint). It will remain in your browser until the server supports reports.</div>';
      form.reset();
    }
  });
})();
</script>
</body>
</html>
